-- show pipe to find ARN to configure access to AWS SQS when files are uploaded to S3 bucket
SHOW PIPES;

-- show stages to confirm stage exists
SHOW STAGES;

-- create file format for reading csv
CREATE OR REPLACE FILE FORMAT my_csv_format TYPE = 'CSV' SKIP_HEADER = 1 FIELD_DELIMITER = ',' TRIM_SPACE = TRUE;

-- create snowpipe and insert batched native data from stage into taxi_info
CREATE OR REPLACE PIPE taxi_pipe 
AUTO_INGEST = TRUE 
AS
COPY INTO taxi_info (VendorID, tpep_pickup_datetime, tpep_dropoff_datetime,
       passenger_count, trip_distance, RatecodeID, store_and_fwd_flag,
       PULocationID, DOLocationID, payment_type, fare_amount, extra,
       mta_tax, tip_amount, tolls_amount, improvement_surcharge,
       total_amount, congestion_surcharge) 
FROM @NATIVE_STAGE
PATTERN='^batched-Native-12/.*\.csv$'
FILE_FORMAT = (FORMAT_NAME = my_csv_format);

-- show 2020 data has been inserted
SELECT count(*) FROM taxi_info WHERE year(tpep_pickup_datetime) = 2020;